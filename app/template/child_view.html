{% extends 'base.html' %} {% block title %}Child Profile - VaccinationTracker{% endblock %} {% block content %}
<div class="bg-white rounded-xl shadow-sm transition-shadow duration-300 hover:shadow-lg p-8 max-w-[800px] mx-auto mb-6 relative max-md:p-3 max-md:mx-1 max-md:mb-3 max-md:rounded-lg max-md:shadow-none max-md:border max-md:border-gray-200 max-sm:p-3 max-sm:mx-0.5 max-sm:mb-2 lg:p-10">
    {% if child %}
    <div class="flex flex-col gap-4" x-data="{editing: false}">
        <span id="editMeta" data-open-edit="{% if editing %}1{% else %}0{% endif %}" class="hidden"></span>
        <div class="flex flex-col justify-center items-center gap-2">
            <p class="text-3xl font-semibold text-gray-800 max-sm:text-2xl max-sm:leading-8">{{ child.name }}</p>
            <p class="text-xl text-gray-700 max-sm:text-lg max-sm:leading-5">Born on: {{ child.dob|short_date }}</p>
            <p class="text-xl text-indigo-500 bg-indigo-100 px-3 py-1 rounded-full max-sm:text-lg max-sm:leading-5">{{ child.dob|age_text }}</p>
            <p class="text-sm text-gray-600">Country: <span class="font-medium text-gray-600">{{ child.country or 'India' }}</span></p>
            {% if reference_url %}
            <a
                href="{{ reference_url }}"
                target="_blank"
                rel="noopener noreferrer"
                class="text-sm text-blue-600 hover:underline"
            >
                Official schedule for {{ child.country or current_country or 'India' }}
            </a>
            {% endif %}
        </div>
        <div class="flex flex-col gap-2 w-full">
            {% if not guest_mode %}
            <a
                href="{{ url_for('views.download_child_calendar', child_id=child.id) }}"
                id="downloadCalendarBtn"
                class="w-full bg-indigo-600 text-xl text-white px-4 py-2 rounded-xl hover:bg-indigo-700 transition duration-200 ease-in-out transform hover:scale-105 shadow-md flex items-center justify-center gap-3 max-sm:text-base max-sm:py-2"
                download
            >
                <span class="material-symbols-outlined">calendar_apps_script</span>
                Download Calendar
            </a>
            {% endif %}
            <div class="flex flex-wrap items-center justify-between gap-3 mt-1">
                <div class="flex flex-wrap gap-2 max-sm:gap-1">
                    {% if stats and stats.total is defined %}
                    <button
                        class="filter-pill inline-block px-3 py-1 text-sm font-medium text-red-600 bg-red-50 border-[1px] border-red-500 rounded-full max-sm:px-2 max-sm:py-1.5 max-sm:text-xs max-sm:leading-3 cursor-pointer hover:bg-red-200 transition-colors duration-200"
                        data-filter="overdue"
                        data-default-classes="text-red-600 bg-red-50 border-red-500"
                        data-active-classes="text-white bg-red-600 border-red-700"
                        >{{ stats.overdue }} Overdue</button
                    >
                    <button
                        class="filter-pill inline-block px-3 py-1 text-sm font-medium text-yellow-600 bg-yellow-50 border-[1px] border-yellow-500 rounded-full max-sm:px-2 max-sm:py-1.5 max-sm:text-xs max-sm:leading-3 cursor-pointer hover:bg-yellow-200 transition-colors duration-200"
                        data-filter="upcoming"
                        data-default-classes="text-yellow-600 bg-yellow-50 border-yellow-500"
                        data-active-classes="text-white bg-yellow-600 border-yellow-700"
                        >{{ stats.due_soon }} Due Soon</button
                    >
                    <button
                        class="filter-pill inline-block px-3 py-1 text-sm font-medium text-green-600 bg-green-50 border-[1px] border-green-500 rounded-full max-sm:px-2 max-sm:py-1.5 max-sm:text-xs max-sm:leading-3 cursor-pointer hover:bg-green-200 transition-colors duration-200"
                        data-filter="completed"
                        data-default-classes="text-green-600 bg-green-50 border-green-500"
                        data-active-classes="text-white bg-green-600 border-green-700"
                        >{{ stats.completed }}/{{ stats.total }} Complete</button
                    >
                    <!-- <button
                        class="filter-pill inline-block px-3 py-1 text-sm font-medium text-gray-600 bg-gray-50 border border-gray-200 rounded-full max-sm:px-2 max-sm:py-1.5 max-sm:text-xs max-sm:leading-3 cursor-pointer hover:bg-gray-100 transition-colors duration-200"
                        data-filter="all"
                        data-default-classes="text-gray-600 bg-gray-50 border-gray-200"
                        data-active-classes="text-white bg-gray-600 border-gray-600"
                        >Show All</button
                    > -->
                    {% endif %}
                </div>
                <button
                    id="editChildBtn"
                    type="button"
                    class="text-gray-600 p-3 rounded-full hover:bg-gray-100 transition duration-200 ease-in-out flex !flex-row items-center justify-center gap-2 text-sm shadow-md max-sm:gap-0 max-sm:ml-auto max-sm:p-2"
                >
                    <span class="material-symbols-outlined">edit_calendar</span>
                    <span class="inline">Edit Child</span>
                </button>
            </div>
        </div>
        <div id="editFormContainer" class="hidden mt-4">
            <form
                method="POST"
                action="{% if guest_mode %}{{ url_for('views.guest_update_child') }}{% else %}{{ url_for('views.update_child', child_id=child.id) }}{% endif %}"
                class="space-y-4 bg-gray-50 p-4 rounded-lg border border-gray-200"
            >
                <h3 class="text-lg font-semibold text-gray-800 max-sm:mb-1">Edit Child Details</h3>
                {% if form_errors %}
                <ul class="text-sm text-red-600 list-disc pl-5">
                    {% for e in form_errors %}
                    <li>{{ e }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
                <div class="flex flex-row gap-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="child_name">Name</label>
                        <input
                            type="text"
                            id="child_name"
                            name="child_name"
                            value="{{ form_data.child_name if form_data and form_data.child_name else child.name }}"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="dob">Date of Birth</label>
                        <input
                            type="date"
                            id="dob"
                            name="dob"
                            value="{{ form_data.dob if form_data and form_data.dob else child.dob.strftime('%Y-%m-%d') }}"
                            required
                            class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="country">Country</label>
                        <select
                            id="country"
                            name="country"
                            class="px-3 py-[0.7rem] border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none"
                            required
                        >
                            {% set selected_country = (form_data.country if form_data and form_data.country else child.country or 'India') %}
                            {% for c in available_countries %}
                            <option value="{{ c }}" {% if c == selected_country %}selected{% endif %}>{{ c }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700">
                        Save
                    </button>
                    <button
                        type="button"
                        id="cancelEditBtn"
                        class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md text-sm hover:bg-gray-400"
                    >
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% else %}
    <p class="text-red-600">Child not found.</p>
    {% endif %}
</div>
<div id="scheduleOutput" class="space-y-4">
    {% if schedule_entries %} {% for entry in schedule_entries %}
    <div class="schedule-card bg-white rounded-xl shadow-sm transition-shadow duration-300 hover:shadow-lg p-3 px-5 max-w-[800px] mx-auto mb-4 max-md:p-3 max-md:mx-1 max-md:mb-3 max-md:rounded-lg max-md:shadow-none max-md:border max-md:border-gray-200 max-sm:p-3 max-sm:mx-0.5 max-sm:mb-1" 
         data-status="{{ 'overdue' if entry.status_text in ['Due', 'Due / Overdue'] else ('upcoming' if entry.status_text == 'Upcoming' else 'completed') }}">
        <!-- Card Header (click to expand) -->
        <div class="flex items-center justify-between cursor-pointer gap-10 max-md:flex-col max-md:items-start max-md:gap-2">
            <div class="flex items-center gap-4 max-md:flex-row-reverse max-md:justify-between max-md:w-full">
                <span class="inline-block px-3 py-1 text-sm font-medium rounded-full max-md:px-2 max-md:min-w-0 max-sm:!px-1.5 max-sm:text-xs max-sm:text-nowrap {{ 'text-red-600 bg-red-50 border border-red-200' if entry.status_text in ['Due', 'Due / Overdue'] else ('text-yellow-600 bg-yellow-50 border border-yellow-200' if entry.status_text == 'Upcoming' else 'text-green-600 bg-green-50 border border-green-200') }}">{{ entry.status_text }}</span>
                <div>
                    <p class="font-semibold text-gray-800 text-base max-sm:text-xl">{{ entry.age }}</p>
                    <p class="text-xs text-gray-600 whitespace-nowrap due-date max-sm:text-xs">
                        Due: {{ entry.due_date|friendly_date if entry.due_date else 'N/A' }}
                    </p>
                </div>
            </div>
            <div class="flex items-center gap-2 max-md:gap-1 max-md:w-full max-md:justify-between">
                <p class="text-sm text-gray-700 whitespace-wrap block max-md:whitespace-normal max-md:block max-md:leading-tight max-md:mt-1 max-md:text-gray-500 max-sm:text-xs max-sm:leading-tight">
                    {{ entry.vaccines | join(', ') }}
                </p>
                <!-- Expand Icon -->
                <svg
                    class="cursor-pointer transition-transform duration-300 w-5 h-5 text-gray-500"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    aria-hidden="true"
                >
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
        </div>
        <!-- Card Details (hidden until expanded) -->
        <div class="max-h-0 overflow-hidden transition-all duration-500 ease-in-out max-md:pt-2">
            <p class="font-semibold mb-1 text-gray-800 max-md:mb-1">Vaccines to be administered:</p>
            <ul class="list-disc pl-5 mb-4 text-sm text-gray-700">
                {% for vac in entry.vaccines %}
                <li class="max-md:mb-0.5">{{ vac }}</li>
                {% endfor %}
            </ul>
            {% if entry.group_completed %}
            <div class="flex items-center gap-2 mb-2">
                <span class="inline-block px-3 py-1 text-sm font-medium text-green-600 bg-green-50 border border-green-200 rounded-full">Completed on {{ entry.group_completed_date|friendly_date }}</span>
            </div>
            {% else %}
            <form
                method="POST"
                action="{% if guest_mode %}{{ url_for('views.guest_mark_vaccination_complete') }}{% else %}{{ url_for('views.mark_vaccination_complete', child_id=child.id) }}{% endif %}"
                class="flex flex-row gap-3 items-center"
            >
                <div>
                    <!-- <label class="block text-xs font-medium text-gray-600 mb-1">Completion Date</label> -->
                    <input
                        type="date"
                        name="date"
                        class="border border-gray-300 rounded-md p-2 text-sm"
                        max="{{ today_str }}"
                        required
                    />
                </div>
                <div class="flex-1">
                    <!-- <label class="block text-xs font-medium text-gray-600 mb-1">Confirm all vaccines complete</label> -->
                    {% if guest_mode %}
                    <input type="hidden" name="age" value="{{ entry.age }}" />
                    {% else %}
                    <select name="vaccine" class="hidden">
                        <!-- send first vaccine name just to satisfy form expects a vaccine value -->
                        <option value="{{ entry.vaccines[0] }}" selected>{{ entry.vaccines[0] }}</option>
                    </select>
                    {% endif %}
                    <button
                        type="submit"
                        class="bg-green-600 text-white px-4 py-2 rounded-md text-sm hover:bg-green-700"
                    >
                        Mark Group Complete
                    </button>
                </div>
            </form>
            {% endif %}
        </div>
    </div>
    {% endfor %} {% else %}
    <p class="text-sm text-gray-500">No schedule entries available.</p>
    {% endif %}
</div>
{% endblock %} {% block scripts %} {{ super() }}
<script>
    // Simple expand/collapse for server-rendered schedule cards
    document.addEventListener("DOMContentLoaded", function () {
        // Schedule card expand/collapse functionality
        document.querySelectorAll("#scheduleOutput .schedule-card > .flex.cursor-pointer").forEach(function (header) {
            header.addEventListener("click", function () {
                const card = header.closest(".schedule-card");
                const details = card.querySelector(".max-h-0");
                const icon = card.querySelector("svg");
                
                if (details.style.maxHeight && details.style.maxHeight !== "0px") {
                    details.style.maxHeight = "0px";
                    details.style.paddingTop = "0";
                    icon.style.transform = "rotate(0deg)";
                } else {
                    details.style.maxHeight = "400px";
                    details.style.paddingTop = "0.75rem";
                    icon.style.transform = "rotate(180deg)";
                }
            });
        });

        // Filter functionality
        let activeFilter = 'all';
        
        function updateFilterButtons() {
            document.querySelectorAll('.filter-pill').forEach(btn => {
                const filter = btn.getAttribute('data-filter');
                const defaultClasses = btn.getAttribute('data-default-classes');
                const activeClasses = btn.getAttribute('data-active-classes');
                
                // Reset to default classes
                btn.className = btn.className.split(' ').filter(cls => 
                    !defaultClasses.includes(cls) && !activeClasses.includes(cls)
                ).join(' ');
                
                if (filter === activeFilter) {
                    // Apply active classes
                    btn.className += ' ' + activeClasses;
                } else {
                    // Apply default classes
                    btn.className += ' ' + defaultClasses;
                }
            });
        }
        
        function filterCards(filterType) {
            const cards = document.querySelectorAll('.schedule-card');
            let visibleCount = 0;
            
            cards.forEach(card => {
                const cardStatus = card.getAttribute('data-status');
                let shouldShow = false;
                
                if (filterType === 'all') {
                    shouldShow = true;
                } else if (filterType === 'overdue' && cardStatus === 'overdue') {
                    shouldShow = true;
                } else if (filterType === 'upcoming' && cardStatus === 'upcoming') {
                    shouldShow = true;
                } else if (filterType === 'completed' && cardStatus === 'completed') {
                    shouldShow = true;
                }
                
                if (shouldShow) {
                    card.style.display = 'block';
                    card.style.opacity = '1';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                    card.style.opacity = '0';
                }
            });
            
            // Show/hide "no entries" message
            const scheduleOutput = document.getElementById('scheduleOutput');
            let noResultsMsg = scheduleOutput.querySelector('.no-results-message');
            
            if (visibleCount === 0 && filterType !== 'all') {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('p');
                    noResultsMsg.className = 'no-results-message text-sm text-gray-500 text-center py-8';
                    scheduleOutput.appendChild(noResultsMsg);
                }
                
                const filterNames = {
                    'overdue': 'overdue',
                    'upcoming': 'upcoming', 
                    'completed': 'completed'
                };
                
                noResultsMsg.textContent = `No ${filterNames[filterType]} vaccination entries found.`;
                noResultsMsg.style.display = 'block';
            } else if (noResultsMsg) {
                noResultsMsg.style.display = 'none';
            }
        }
        
        // Add click event listeners to filter buttons
        document.querySelectorAll('.filter-pill').forEach(btn => {
            btn.addEventListener('click', function() {
                const filter = this.getAttribute('data-filter');
                
                // Toggle filter - if clicking the same filter, show all
                if (activeFilter === filter) {
                    activeFilter = 'all';
                } else {
                    activeFilter = filter;
                }
                
                updateFilterButtons();
                filterCards(activeFilter);
            });
        });
        
        // Initialize with "Show All" selected
        updateFilterButtons();
        filterCards('all');

        // Child edit functionality
        const editBtn = document.getElementById("editChildBtn");
        const editContainer = document.getElementById("editFormContainer");
        const cancelEditBtn = document.getElementById("cancelEditBtn");
        if (editBtn && editContainer) {
            editBtn.addEventListener("click", () => {
                editContainer.classList.toggle("hidden");
            });
        }
        if (cancelEditBtn && editContainer) {
            cancelEditBtn.addEventListener("click", () => {
                editContainer.classList.add("hidden");
            });
        }
        const editMeta = document.getElementById("editMeta");
        const shouldOpenEdit = editMeta && editMeta.getAttribute("data-open-edit") === "1";
        if (shouldOpenEdit && editContainer) editContainer.classList.remove("hidden");
    });
</script>
{% endblock %}
