{% extends 'base.html' %} {% block title %}Child Profile - VaccinationTracker{% endblock %} {% block content %}
<div class="combined-card mb-6 vt-child-profile-card vt-card-primary">
    <!-- <h2 class="text-2xl font-bold text-gray-800 mb-4">Child Profile</h2> -->
    {% if child %}
    <div class="flex flex-col gap-4 vt-child-profile" x-data="{editing: false}">
        <span id="editMeta" data-open-edit="{% if editing %}1{% else %}0{% endif %}" class="hidden"></span>
        <div class="flex flex-col justify-center items-center vt-childInfo gap-[0.5rem]">
            <p class="text-3xl font-semibold text-gray-800">{{ child.name }}</p>
            <p class="text-xl text-gray-700">Born on: {{ child.dob|short_date }}</p>
            <p class="text-xl text-indigo-500 bg-indigo-100 px-3 py-1 rounded-full">{{ child.dob|age_text }}</p>
            <p class="text-sm text-gray-600">Country: <span class="font-medium text-gray-600">{{ child.country or 'India' }}</span></p>
            {% if reference_url %}
            <a
                href="{{ reference_url }}"
                target="_blank"
                rel="noopener noreferrer"
                class="text-sm text-blue-600 hover:underline"
            >
                Official schedule for {{ child.country or current_country or 'India' }}
            </a>
            {% endif %}
        </div>
        <div class="flex flex-col gap-2 w-full">
            {% if not guest_mode %}
            <a
                href="{{ url_for('views.download_child_calendar', child_id=child.id) }}"
                id="downloadCalendarBtn"
                class="w-full bg-indigo-600 text-xl text-white px-4 py-2 rounded-xl hover:bg-indigo-700 transition duration-200 ease-in-out transform hover:scale-105 shadow-md flex items-center justify-center gap-3"
                download
            >
                <span class="material-symbols-outlined">calendar_apps_script</span>
                Download Calendar
            </a>
            {% endif %}
            <div class="flex flex-wrap items-center justify-between gap-3 mt-1 vt-totalstats">
                <div class="flex flex-wrap gap-2">
                    {% if stats and stats.total is defined %}
                    <span
                        class="px-3 py-1 text-sm font-medium text-red-600 bg-red-50 border border-red-200 rounded-full"
                        >{{ stats.overdue }} Overdue</span
                    >
                    <span
                        class="px-3 py-1 text-sm font-medium text-yellow-600 bg-yellow-50 border border-yellow-200 rounded-full"
                        >{{ stats.due_soon }} Due Soon</span
                    >
                    <span
                        class="px-3 py-1 text-sm font-medium text-green-600 bg-green-50 border border-green-200 rounded-full"
                        >{{ stats.completed }}/{{ stats.total }} Complete</span
                    >
                    {% endif %}
                </div>
                <button
                    id="editChildBtn"
                    type="button"
                    class="text-gray-600 p-3 rounded-full hover:bg-gray-100 transition duration-200 ease-in-out flex !flex-row items-center justify-center gap-2 text-sm shadow-md"
                >
                    <span class="material-symbols-outlined">edit_calendar</span>
                    <span class="inline">Edit Child</span>
                </button>
            </div>
        </div>
        <div id="editFormContainer" class="hidden mt-4 vt-edit-child-form">
            <form
                method="POST"
                action="{% if guest_mode %}{{ url_for('views.guest_update_child') }}{% else %}{{ url_for('views.update_child', child_id=child.id) }}{% endif %}"
                class="space-y-4 bg-gray-50 p-4 rounded-lg border border-gray-200"
            >
                <h3 class="text-lg font-semibold text-gray-800">Edit Child Details</h3>
                {% if form_errors %}
                <ul class="text-sm text-red-600 list-disc pl-5">
                    {% for e in form_errors %}
                    <li>{{ e }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
                <div class="flex flex-row gap-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="child_name">Name</label>
                        <input
                            type="text"
                            id="child_name"
                            name="child_name"
                            value="{{ form_data.child_name if form_data and form_data.child_name else child.name }}"
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="dob">Date of Birth</label>
                        <input
                            type="date"
                            id="dob"
                            name="dob"
                            value="{{ form_data.dob if form_data and form_data.dob else child.dob.strftime('%Y-%m-%d') }}"
                            required
                            class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="country">Country</label>
                        <select
                            id="country"
                            name="country"
                            class="px-3 py-[0.7rem] border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none"
                            required
                        >
                            {% set selected_country = (form_data.country if form_data and form_data.country else child.country or 'India') %}
                            {% for c in available_countries %}
                            <option value="{{ c }}" {% if c == selected_country %}selected{% endif %}>{{ c }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700">
                        Save
                    </button>
                    <button
                        type="button"
                        id="cancelEditBtn"
                        class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md text-sm hover:bg-gray-400"
                    >
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% else %}
    <p class="text-red-600">Child not found.</p>
    {% endif %}
</div>
<div id="scheduleOutput" class="space-y-4 vt-schedule-output">
    {% if schedule_entries %} {% for entry in schedule_entries %}
    <div class="schedule-card vt-schedule-card">
        <!-- Card Header (click to expand) -->
        <div class="flex items-center justify-between cursor-pointer gap-10 vt-schedule-header">
            <div class="flex items-center gap-4 schedule-card-info vt-schedule-card-info vt-schedule-meta">
                <span class="{{ entry.status_class }}">{{ entry.status_text }}</span>
                <div>
                    <p class="font-semibold text-gray-800 text-base vt-vaccine-age">{{ entry.age }}</p>
                    <p class="text-xs text-gray-600 whitespace-nowrap due-date">
                        Due: {{ entry.due_date|friendly_date if entry.due_date else 'N/A' }}
                    </p>
                </div>
            </div>
            <div class="flex items-center gap-2 vt-schedule-meta">
                <p class="text-sm text-gray-700 whitespace-wrap block vt-vaccine-inline-text">
                    {{ entry.vaccines | join(', ') }}
                </p>
                <!-- Expand Icon -->
                <svg
                    class="expand-icon w-5 h-5 text-gray-500"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    aria-hidden="true"
                >
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
        </div>
        <!-- Card Details (hidden until expanded) -->
        <div class="card-details">
            <p class="font-semibold mb-1 text-gray-800">Vaccines to be administered:</p>
            <ul class="list-disc pl-5 mb-4 text-sm text-gray-700">
                {% for vac in entry.vaccines %}
                <li>{{ vac }}</li>
                {% endfor %}
            </ul>
            {% if entry.group_completed %}
            <div class="flex items-center gap-2 mb-2">
                <span class="status-completed">Completed on {{ entry.group_completed_date|friendly_date }}</span>
            </div>
            {% else %}
            <form
                method="POST"
                action="{% if guest_mode %}{{ url_for('views.guest_mark_vaccination_complete') }}{% else %}{{ url_for('views.mark_vaccination_complete', child_id=child.id) }}{% endif %}"
                class="flex flex-row gap-3 items-center"
            >
                <div>
                    <!-- <label class="block text-xs font-medium text-gray-600 mb-1">Completion Date</label> -->
                    <input
                        type="date"
                        name="date"
                        class="border border-gray-300 rounded-md p-2 text-sm"
                        max="{{ today_str }}"
                        required
                    />
                </div>
                <div class="flex-1">
                    <!-- <label class="block text-xs font-medium text-gray-600 mb-1">Confirm all vaccines complete</label> -->
                    {% if guest_mode %}
                    <input type="hidden" name="age" value="{{ entry.age }}" />
                    {% else %}
                    <select name="vaccine" class="hidden">
                        <!-- send first vaccine name just to satisfy form expects a vaccine value -->
                        <option value="{{ entry.vaccines[0] }}" selected>{{ entry.vaccines[0] }}</option>
                    </select>
                    {% endif %}
                    <button
                        type="submit"
                        class="bg-green-600 text-white px-4 py-2 rounded-md text-sm hover:bg-green-700"
                    >
                        Mark Group Complete
                    </button>
                </div>
            </form>
            {% endif %}
        </div>
    </div>
    {% endfor %} {% else %}
    <p class="text-sm text-gray-500">No schedule entries available.</p>
    {% endif %}
</div>
{% endblock %} {% block scripts %} {{ super() }}
<script>
    // Simple expand/collapse for server-rendered schedule cards
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll("#scheduleOutput .schedule-card > .flex.cursor-pointer").forEach(function (header) {
            header.addEventListener("click", function () {
                const card = header.closest(".schedule-card");
                card.classList.toggle("expanded");
            });
        });

        const editBtn = document.getElementById("editChildBtn");
        const editContainer = document.getElementById("editFormContainer");
        const cancelEditBtn = document.getElementById("cancelEditBtn");
        if (editBtn && editContainer) {
            editBtn.addEventListener("click", () => {
                editContainer.classList.toggle("hidden");
            });
        }
        if (cancelEditBtn && editContainer) {
            cancelEditBtn.addEventListener("click", () => {
                editContainer.classList.add("hidden");
            });
        }
        const editMeta = document.getElementById("editMeta");
        const shouldOpenEdit = editMeta && editMeta.getAttribute("data-open-edit") === "1";
        if (shouldOpenEdit && editContainer) editContainer.classList.remove("hidden");
    });
</script>
{% endblock %}
