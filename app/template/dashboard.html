{% extends 'base.html' %} {% block title %}Dashboard - VaccinationTracker{% endblock %} {% block content %}
<div id="profilesDashboard" class="mt-4 max-w-[800px] mx-auto">
    <!-- Stats overview -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
        <div class="bg-white border border-gray-200 rounded-xl p-3 px-4 max-md:p-3 max-md:px-3">
            <div class="text-sm text-gray-500">Total Children</div>
            <div id="statTotal" class="font-bold text-xl text-gray-800">
                {{ (children|length) + (1 if guest_child else 0) }}
            </div>
        </div>
        <div class="bg-white border border-gray-200 rounded-xl p-3 px-4 max-md:p-3 max-md:px-3">
            <div class="text-sm text-gray-500">Completed</div>
            <div id="statCompleted" class="font-bold text-xl text-gray-800">{{ overall_completed }}</div>
        </div>
        <div class="bg-white border border-gray-200 rounded-xl p-3 px-4 max-md:p-3 max-md:px-3">
            <div class="text-sm text-gray-500">Overdue</div>
            <div id="statOverdue" class="font-bold text-xl text-red-600">{{ overall_overdue }}</div>
        </div>
        <div class="bg-white border border-gray-200 rounded-xl p-3 px-4 max-md:p-3 max-md:px-3">
            <div class="text-sm text-gray-500">Upcoming / Due Soon</div>
            <div id="statUpcoming" class="font-bold text-xl text-blue-600">{{ overall_upcoming }}</div>
        </div>
    </div>

    <!-- Profiles list -->
    <div id="profilesList" class="space-y-2 mt-4">
        {% if guest_child %}
        <!-- Guest Child Card -->
        <div
            class="bg-white border border-gray-200 rounded-xl p-3 px-4 flex items-center justify-between max-sm:flex-col max-sm:gap-4"
        >
            <div class="flex !w-full flex-col">
                <div class="flex items-center justify-between gap-2 flex-wrap">
                    <div class="flex gap-4 items-baseline">
                        <span class="!text-2xl font-semibold text-gray-800">{{ guest_child.name }}</span>
                        <span class="!text-sm text-gray-600">
                            <strong>Born:</strong> {{ guest_child.dob|friendly_date if guest_child.dob else 'N/A' }}
                        </span>
                        <span class="!text-sm text-gray-600">
                            <strong>Country:</strong> {{ guest_child.country or 'India' }}
                        </span>
                    </div>
                    <div class="flex items-center gap-2 max-sm:gap-1">
                        <span
                            class="inline-block px-3 py-1 text-sm font-medium text-red-600 bg-red-50 border border-red-200 rounded-full max-sm:px-1 max-sm:py-0.5 max-sm:text-xs max-sm:leading-3 max-sm:text-nowrap"
                            >{{ overall_overdue }} Overdue</span
                        >
                        <span
                            class="inline-block px-3 py-1 text-sm font-medium text-yellow-600 bg-yellow-50 border border-yellow-200 rounded-full max-sm:px-1 max-sm:py-0.5 max-sm:text-xs max-sm:leading-3 max-sm:text-nowrap"
                            >{{ (overall_upcoming - overall_overdue) }} Due Soon</span
                        >
                        <span
                            class="inline-block px-3 py-1 text-sm font-medium text-green-600 bg-green-50 border border-green-200 rounded-full max-sm:px-1 max-sm:py-0.5 max-sm:text-xs max-sm:leading-3 max-sm:text-nowrap"
                            >{{ overall_completed }}/{{ overall_completed + overall_overdue + overall_upcoming }}
                            Complete</span
                        >
                    </div>
                </div>
                <div class="mt-3 bg-blue-50 text-blue-900 rounded-md p-3">
                    <div class="text-sm">
                        <strong>Next Due:</strong> {{ guest_next_due|friendly_date if guest_next_due else 'N/A' }}
                    </div>
                    <div class="text-lg">
                        {{ guest_next_vaccines|join(', ') if guest_next_vaccines else 'All done' }}
                    </div>
                </div>
            </div>
            <div class="flex flex-1 flex-col !w-full items-center gap-2 ml-3">
                <a
                    href="{{ url_for('views.guest_child_view') }}"
                    class="flex flex-row justify-center items-center gap-1 !w-full view-btn bg-gray-100 text-gray-800 px-3 py-1 rounded-md text-sm hover:bg-gray-200"
                >
                    <span class="material-symbols-outlined">read_more</span>
                    View
                </a>
                <a
                    href="{{ url_for('auth.register') }}"
                    class="flex flex-row justify-center items-center gap-1 w-full bg-blue-600 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-700"
                >
                    <span class="material-symbols-outlined">person_add</span>
                    Create Account
                </a>
            </div>
        </div>
        <!-- Guest Child Note -->
        <div class="mt-2 bg-yellow-100 text-yellow-900 rounded-md p-3 border-l-4 border-yellow-400">
            <div class="text-sm">
                <strong>Note:</strong> This is a temporary profile. Create an account to save your data permanently and
                access additional features.
            </div>
        </div>
        {% endif %} {% if not children and not guest_child %}
        <div class="text-sm text-gray-600 p-3">No profiles yet. Add a child to get started.</div>
        {% else %} {% for s in child_stats %}
        <div
            class="bg-white border border-gray-200 rounded-xl p-3 px-4 flex items-center justify-between max-sm:flex-col max-sm:gap-4"
        >
            <div class="flex !w-full flex-col">
                <div class="flex items-center justify-between gap-2 flex-wrap">
                    <div class="flex gap-4 items-baseline">
                        <span class="!text-2xl font-semibold text-gray-800">{{ s.child.name }}</span>
                        <span class="!text-sm text-gray-600"
                            ><strong>Born:</strong> {{ s.child.dob|friendly_date }}</span
                        >
                        <span class="!text-sm text-gray-600"
                            ><strong>Country:</strong> {{ s.child.country or 'India' }}</span
                        >
                    </div>
                    <div class="flex items-center gap-2 max-sm:gap-1">
                        <span
                            class="inline-block px-3 py-1 text-sm font-medium text-red-600 bg-red-50 border border-red-200 rounded-full max-sm:px-1 max-sm:py-0.5 max-sm:text-xs max-sm:leading-3 max-sm:text-nowrap"
                            >{{ s.overdue }} Overdue</span
                        >
                        <span
                            class="inline-block px-3 py-1 text-sm font-medium text-yellow-600 bg-yellow-50 border border-yellow-200 rounded-full max-sm:px-1 max-sm:py-0.5 max-sm:text-xs max-sm:leading-3 max-sm:text-nowrap"
                            >{{ s.due_soon }} Due Soon</span
                        >
                        <span
                            class="inline-block px-3 py-1 text-sm font-medium text-green-600 bg-green-50 border border-green-200 rounded-full max-sm:px-1 max-sm:py-0.5 max-sm:text-xs max-sm:leading-3 max-sm:text-nowrap"
                            >{{ s.completed }}/{{ s.total }} Complete</span
                        >
                    </div>
                </div>
                <div class="mt-3 bg-blue-50 text-blue-900 rounded-md p-3">
                    <div class="text-sm">
                        <strong>Next Due:</strong> {{ s.next_due|friendly_date if s.next_due else 'N/A' }}
                    </div>
                    <div class="text-lg">
                        {{ s.next_due_vaccines|join(', ') if s.next_due_vaccines else 'All done' }}
                    </div>
                </div>
            </div>
            <div class="flex flex-1 flex-col !w-full items-center gap-2 ml-3">
                <a
                    href="{{ url_for('views.child_view', child_id=s.child.id) }}"
                    class="flex flex-row justify-center items-center gap-1 !w-full view-btn bg-gray-100 text-gray-800 px-3 py-1 rounded-md text-sm hover:bg-gray-200"
                >
                    <span class="material-symbols-outlined">read_more</span>
                    View
                </a>
                <button
                    type="button"
                    onclick="showDeleteModal('{{ s.child.name }}', `{{ url_for('views.delete_child', child_id=s.child.id) }}`)"
                    class="flex flex-row justify-center items-center gap-1 w-full bg-red-600 text-white px-3 py-1 rounded-md text-sm hover:bg-red-700"
                >
                    <span class="material-symbols-outlined">delete</span>
                    Delete
                </button>
            </div>
        </div>
        {% endfor %} {% endif %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 mx-4 max-w-md w-full shadow-2xl">
        <div class="flex items-center mb-4">
            <span class="material-symbols-outlined text-red-600 text-3xl mr-3">warning</span>
            <h3 class="text-xl font-bold text-gray-800">Confirm Deletion</h3>
        </div>
        <p class="text-gray-600 mb-6">
            Are you sure you want to delete <strong id="childNameToDelete"></strong> and all vaccination records?
            <br /><br />
            <span class="text-red-600 font-medium">This action cannot be undone.</span>
        </p>
        <div class="flex gap-3 justify-end">
            <button
                type="button"
                onclick="hideDeleteModal()"
                class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors"
            >
                Cancel
            </button>
            <form id="deleteForm" method="POST" action="" class="inline">
                <button
                    type="submit"
                    class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors"
                >
                    Delete
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    function showDeleteModal(childName, deleteUrl) {
        document.getElementById("childNameToDelete").textContent = childName;
        document.getElementById("deleteForm").action = deleteUrl;
        const modal = document.getElementById("deleteModal");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
    }

    function hideDeleteModal() {
        const modal = document.getElementById("deleteModal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
    }

    // Close modal when clicking outside
    document.getElementById("deleteModal").addEventListener("click", function (e) {
        if (e.target === this) {
            hideDeleteModal();
        }
    });

    // Close modal with Escape key
    document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
            hideDeleteModal();
        }
    });
</script>

{% endblock %}
