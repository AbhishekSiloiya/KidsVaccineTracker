{% extends "base.html" %} {% block title %}Schedule Comparison - VaccinationTracker{% endblock %} {% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="emboss-bg p-6 rounded-2xl shadow-lg mb-8 max-md:p-4 max-sm:p-3 max-sm:mb-6">
        <div class="text-center mb-6 max-sm:mb-4">
            <h2 class="text-3xl font-bold text-gray-800 mb-2 max-sm:text-2xl max-sm:mb-1">
                <span class="material-symbols-outlined text-4xl align-middle mr-2 max-sm:text-3xl">compare</span>
                Vaccination Schedule Comparison
            </h2>
            <p class="text-lg text-gray-600 max-sm:text-base">
                Compare vaccination schedules across different countries
            </p>
        </div>

        <!-- Country Selection Form -->
        <form method="GET" class="bg-white rounded-xl p-4 border-2 border-gray-200 max-sm:p-3">
            <div class="flex flex-wrap items-center gap-4 max-sm:gap-2">
                <label class="text-lg font-semibold text-gray-700 max-sm:text-base">Select Countries:</label>
                <div class="flex flex-wrap gap-2 max-sm:gap-1">
                    {% for country in available_countries %}
                    <label
                        class="inline-flex items-center gap-2 bg-gray-50 hover:bg-gray-100 px-3 py-2 rounded-lg border border-gray-200 cursor-pointer transition-colors max-sm:px-2 max-sm:py-1 max-sm:text-sm"
                    >
                        <input
                            type="checkbox"
                            name="countries"
                            value="{{ country }}"
                            {%
                            if
                            country
                            in
                            selected_countries
                            %}checked{%
                            endif
                            %}
                            class="text-indigo-600 rounded"
                        />
                        <span class="font-medium">{{ country }}</span>
                    </label>
                    {% endfor %}
                </div>
                <button
                    type="submit"
                    class="emboss-outset bg-indigo-600 text-white px-6 py-2 rounded-xl font-semibold hover:bg-indigo-700 transition-all duration-200 max-sm:px-4 max-sm:py-1.5 max-sm:text-sm"
                >
                    Compare
                </button>
            </div>
        </form>
    </div>

    <!-- Comparison Table -->
    {% if comparison_table %}
    <div class="emboss-bg rounded-2xl shadow-lg overflow-hidden max-sm:rounded-lg">
        <div class="overflow-x-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100">
            <table
                class="min-w-full table-fixed max-sm:w-[calc(100vw-2rem)] comparison-table"
                style="--country-count: {{ selected_countries|length }};"
            >
                <!-- Table Header -->
                <thead class="bg-gray-50 border-b-2 border-gray-200">
                    <tr>
                        <th
                            class="px-3 py-4 text-left font-bold text-gray-800 sticky left-0 bg-gray-50 z-10 border-r-2 border-gray-200 max-sm:px-2 max-sm:py-3 comparison-age-col"
                        >
                            <div class="flex justify-center items-center gap-1 max-sm:flex-col max-sm:gap-0">
                                <span class="material-symbols-outlined text-lg max-sm:text-sm">schedule</span>
                                <span class="text-sm max-sm:text-xs max-sm:leading-tight">Age</span>
                            </div>
                        </th>
                        {% for country in selected_countries %}
                        <th
                            class="px-4 py-4 text-left font-bold text-gray-800 border-r border-gray-200 max-sm:px-2 max-sm:py-3 comparison-country-col"
                        >
                            <div class="flex flex-col items-center gap-1">
                                <div class="flex items-center gap-1 max-sm:flex-col max-sm:gap-0">
                                    <span class="material-symbols-outlined text-lg max-sm:text-sm">flag</span>
                                    <span class="text-sm max-sm:text-xs font-semibold max-sm:leading-tight text-center"
                                        >{{ country }}</span
                                    >
                                </div>
                                {% if comparison_data[country].reference_url %}
                                <a
                                    href="{{ comparison_data[country].reference_url }}"
                                    target="_blank"
                                    class="text-xs text-indigo-600 hover:underline flex items-center gap-1 max-sm:hidden"
                                >
                                    <span class="material-symbols-outlined text-sm">open_in_new</span>
                                    Official Source
                                </a>
                                {% endif %}
                            </div>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>

                <!-- Table Body -->
                <tbody class="bg-white">
                    {% for row in comparison_table %}
                    <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
                        <td
                            class="px-3 py-4 font-semibold text-gray-700 sticky left-0 bg-white z-10 border-r-2 border-gray-200 max-sm:px-2 max-sm:py-3 comparison-age-col"
                        >
                            <div
                                class="text-xs max-sm:text-2xs leading-tight max-sm:leading-none break-words text-center"
                            >
                                {{ row.age }}
                            </div>
                        </td>
                        {% for country in selected_countries %}
                        <td
                            class="px-4 py-4 border-r border-gray-200 align-top max-sm:px-2 max-sm:py-3 comparison-country-col"
                        >
                            {% if row.countries[country] %}
                            <div class="space-y-1 max-sm:space-y-0.5">
                                {% for vaccine in row.countries[country] %}
                                <span
                                    class="vaccine-pill inline-block bg-indigo-100 text-indigo-800 text-xs px-2 py-0.5 rounded-full font-medium max-sm:text-2xs max-sm:px-1.5 max-sm:py-0.5 max-sm:mb-0.5 max-sm:mr-0.5"
                                >
                                    {{ vaccine }}
                                </span>
                                {% endfor %}
                            </div>
                            {% else %}
                            <span class="text-gray-400 italic text-xs max-sm:text-2xs">No vaccines</span>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Statistics Summary -->
    <div class="mt-8 grid grid-cols-1 md:grid-cols-{{ selected_countries|length }} gap-6 max-sm:mt-6 max-sm:gap-4">
        {% for country in selected_countries %}
        <div class="emboss-outset bg-white rounded-xl p-6 text-center max-sm:p-4">
            <h3 class="text-xl font-bold text-gray-800 mb-2 max-sm:text-lg">{{ country }}</h3>
            <div class="text-3xl font-bold text-indigo-600 mb-1 max-sm:text-2xl">
                {{ comparison_data[country].schedule|length }}
            </div>
            <div class="text-gray-600 max-sm:text-sm">Age Groups</div>

            {% set total_vaccines = 0 %} {% for item in comparison_data[country].schedule %} {% set total_vaccines =
            total_vaccines + item.vaccines|length %} {% endfor %}
            <div class="mt-4 text-lg font-semibold text-gray-700 max-sm:text-base">
                {{ total_vaccines }} Total Vaccines
            </div>

            {% if comparison_data[country].reference_url %}
            <a
                href="{{ comparison_data[country].reference_url }}"
                target="_blank"
                class="mt-3 inline-flex items-center gap-1 text-indigo-600 hover:underline text-sm"
            >
                <span class="material-symbols-outlined text-sm">open_in_new</span>
                View Official Schedule
            </a>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Key Differences Section -->
    {% if selected_countries|length >= 2 %}
    <div class="mt-8 emboss-bg rounded-2xl p-6 max-sm:mt-6 max-sm:p-4">
        <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2 max-sm:text-xl max-sm:mb-3">
            <span class="material-symbols-outlined text-3xl text-indigo-600">insights</span>
            Key Insights
        </h3>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 max-sm:gap-4">
            <!-- Unique Vaccines -->
            <div class="bg-white rounded-xl p-4 border-2 border-gray-200">
                <h4 class="font-semibold text-gray-800 mb-3 max-sm:text-sm">Country-Specific Vaccines</h4>
                <div class="space-y-2">
                    {% for country in selected_countries %} {% set country_vaccines = [] %} {% for item in
                    comparison_data[country].schedule %} {% for vaccine in item.vaccines %} {% if vaccine not in
                    country_vaccines %} {% set _ = country_vaccines.append(vaccine) %} {% endif %} {% endfor %} {%
                    endfor %}

                    <div class="max-sm:text-sm">
                        <strong class="text-indigo-600">{{ country }}:</strong>
                        <span class="text-gray-600">{{ country_vaccines|length }} unique vaccine types</span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Schedule Timing -->
            <div class="bg-white rounded-xl p-4 border-2 border-gray-200">
                <h4 class="font-semibold text-gray-800 mb-3 max-sm:text-sm">Schedule Timing</h4>
                <div class="space-y-2">
                    {% for country in selected_countries %} {% set first_age = comparison_data[country].schedule[0].age
                    if comparison_data[country].schedule %}
                    <div class="max-sm:text-sm">
                        <strong class="text-indigo-600">{{ country }}:</strong>
                        <span class="text-gray-600">Starts at {{ first_age if first_age else 'N/A' }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %} {% else %}
    <div class="text-center py-12 max-sm:py-8">
        <div class="text-gray-400 mb-4">
            <span class="material-symbols-outlined text-6xl max-sm:text-4xl">search_off</span>
        </div>
        <p class="text-xl text-gray-600 max-sm:text-lg">No countries selected for comparison</p>
        <p class="text-gray-500 mt-2 max-sm:text-sm">
            Please select at least one country above to view the comparison.
        </p>
    </div>
    {% endif %}
</div>

<!-- Country Selection Script -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Auto-submit form when selections change
        const checkboxes = document.querySelectorAll('input[name="countries"]');
        const submitBtn = document.querySelector('button[type="submit"]');

        checkboxes.forEach((checkbox) => {
            checkbox.addEventListener("change", function () {
                // Ensure at least one country is selected
                const checkedBoxes = document.querySelectorAll('input[name="countries"]:checked');
                if (checkedBoxes.length === 0) {
                    this.checked = true; // Prevent unchecking the last one
                    return;
                }

                // Auto-submit after a short delay to allow multiple selections
                clearTimeout(this.submitTimeout);
                this.submitTimeout = setTimeout(() => {
                    submitBtn.click();
                }, 500);
            });
        });

        // Table responsive scroll indicator
        const tableContainer = document.querySelector(".overflow-x-auto");
        if (tableContainer) {
            const table = tableContainer.querySelector("table");
            if (table && table.offsetWidth > tableContainer.clientWidth) {
                tableContainer.classList.add("shadow-inner");
            }
        }
    });
</script>
{% endblock %}
